@startuml Login Flow
title User Login Sequence Diagram

actor User
participant "Frontend App" as Frontend
participant "FastAPI Server" as API
participant "Auth Service" as AuthService
participant "User Service" as UserService
participant "Database" as DB
participant "Logging System" as Logger
participant "Circuit Breaker" as CB

User -> Frontend: Enter login credentials\n(email/username, password)
Frontend -> API: POST /api/auth/login\n{email_or_username, password}

API -> Logger: Log login attempt (user_identifier)
API -> AuthService: authenticate_user(credentials)

AuthService -> UserService: get_user_by_email_or_username(identifier)
UserService -> CB: execute_with_circuit_breaker()
CB -> DB: SELECT * FROM users WHERE email = ? OR username = ?

alt User Found
    DB -> CB: Return user record
    CB -> UserService: Return user object
    UserService -> AuthService: Return user

    AuthService -> AuthService: verify_password(plain_password, hashed_password)

    alt Password Valid
        AuthService -> AuthService: generate_jwt_token(user)
        AuthService -> API: Return {user, access_token}
        API -> Logger: Log successful login
        API -> Frontend: HTTP 200: {user_data, access_token, token_type}
        Frontend -> Frontend: Store token in localStorage/cookies
        Frontend -> User: Login successful,\nredirect to dashboard
    else Invalid Password
        AuthService -> API: Return None (invalid credentials)
        API -> Logger: Log failed login attempt (invalid password)
        API -> Frontend: HTTP 401: Invalid credentials
        Frontend -> User: Display "Invalid credentials" error
    end

else User Not Found
    DB -> CB: No user found
    CB -> UserService: Return None
    UserService -> AuthService: Return None
    AuthService -> API: Return None (invalid credentials)
    API -> Logger: Log failed login attempt (user not found)
    API -> Frontend: HTTP 401: Invalid credentials
    Frontend -> User: Display "Invalid credentials" error
end

alt Database Connection Failure
    CB -> UserService: DatabaseConnectionError
    UserService -> AuthService: DatabaseError
    AuthService -> API: Raise HTTP 500 Internal Server Error
    API -> Logger: Log database connection error
    API -> Frontend: HTTP 500: Internal server error
    Frontend -> User: Display "Service temporarily unavailable"
end

alt Circuit Breaker Open
    CB -> UserService: CircuitBreakerOpen
    UserService -> AuthService: ServiceUnavailableError
    AuthService -> API: Raise HTTP 503 Service Unavailable
    API -> Logger: Log service unavailable
    API -> Frontend: HTTP 503: Service temporarily unavailable
    Frontend -> User: Display "Service temporarily unavailable"
end

@enduml