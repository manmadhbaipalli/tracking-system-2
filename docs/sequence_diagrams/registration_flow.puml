@startuml Registration Flow
title User Registration Sequence Diagram

actor User
participant "Frontend App" as Frontend
participant "FastAPI Server" as API
participant "Auth Service" as AuthService
participant "User Service" as UserService
participant "Database" as DB
participant "Logging System" as Logger
participant "Circuit Breaker" as CB

User -> Frontend: Enter registration details\n(email, username, password)
Frontend -> API: POST /api/auth/register\n{email, username, password}

API -> Logger: Log registration attempt
API -> AuthService: validate_registration_data(user_data)

AuthService -> UserService: check_user_exists(email, username)
UserService -> CB: execute_with_circuit_breaker()
CB -> DB: SELECT users WHERE email/username

alt User already exists
    DB -> CB: User found
    CB -> UserService: Return user exists
    UserService -> AuthService: UserAlreadyExistsError
    AuthService -> API: Raise HTTP 409 Conflict
    API -> Logger: Log registration failure (user exists)
    API -> Frontend: HTTP 409: User already exists
    Frontend -> User: Display error message
else User doesn't exist
    DB -> CB: No user found
    CB -> UserService: Return no user

    UserService -> AuthService: User available
    AuthService -> AuthService: hash_password(password)
    AuthService -> UserService: create_user(hashed_data)

    UserService -> CB: execute_with_circuit_breaker()
    CB -> DB: INSERT INTO users VALUES(...)

    alt Database Insert Success
        DB -> CB: Insert successful, return user_id
        CB -> UserService: Return created user
        UserService -> AuthService: Return user object
        AuthService -> AuthService: generate_jwt_token(user)
        AuthService -> API: Return {user, access_token}
        API -> Logger: Log successful registration
        API -> Frontend: HTTP 201: {user_data, access_token}
        Frontend -> User: Registration successful,\nredirect to dashboard
    else Database Insert Failure
        DB -> CB: Insert failed
        CB -> UserService: DatabaseError
        UserService -> AuthService: DatabaseError
        AuthService -> API: Raise HTTP 500 Internal Error
        API -> Logger: Log database error
        API -> Frontend: HTTP 500: Registration failed
        Frontend -> User: Display error message
    end
end

alt Circuit Breaker Open
    CB -> UserService: CircuitBreakerOpen
    UserService -> AuthService: ServiceUnavailableError
    AuthService -> API: Raise HTTP 503 Service Unavailable
    API -> Logger: Log service unavailable
    API -> Frontend: HTTP 503: Service temporarily unavailable
    Frontend -> User: Service unavailable message
end

@enduml