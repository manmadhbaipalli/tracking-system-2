@startuml Architecture Diagram

!theme plain
skinparam backgroundColor #FEFEFE
skinparam sequenceParticipant underline

package "FastAPI Application" {
    [FastAPI App] as app
    [Swagger UI\n/docs] as swagger
    [OpenAPI JSON\n/openapi.json] as openapi
}

package "Middleware Layer" {
    [LoggingMiddleware\n- Correlation ID\n- Request/Response Logging\n- Sensitive Data Filter] as logging_mw
    [Exception Handlers\n- Global handlers\n- Error formatting] as exception_mw
}

package "Router Layer" {
    [AuthRouter\n- POST /api/v1/auth/register\n- POST /api/v1/auth/login] as router
}

package "Service Layer" {
    [AuthService\n- User registration\n- User authentication\n- Password validation\n- Rate limiting] as auth_service
    [CircuitBreaker\n- CLOSED/OPEN/HALF_OPEN\n- State management\n- Failure tracking] as circuit_breaker
}

package "Utils Layer" {
    [Security Utils\n- Password hashing (bcrypt)\n- JWT generation/validation\n- Token management] as security
}

package "Data Access Layer" {
    [SQLAlchemy ORM\n- User model\n- LoginAttempts model\n- Database queries] as orm
}

package "Database" {
    [PostgreSQL\n- users table\n- login_attempts table] as database
}

' Relationships
app --> swagger
app --> openapi
app --> logging_mw
logging_mw --> exception_mw
exception_mw --> router

router --> auth_service
auth_service --> security
auth_service --> orm
auth_service --> circuit_breaker

orm --> database

circuit_breaker -.-> auth_service : "Protects\nexternal calls"

note right of logging_mw
    Intercepts all requests
    Generates/propagates correlation IDs
    Logs request and response
    Filters passwords/tokens
end note

note right of auth_service
    Contains business logic
    Validates input data
    Enforces rate limiting
    Manages account locking
end note

note right of orm
    Async SQLAlchemy
    Async support with asyncpg
    Connection pooling
    Transaction management
end note

note right of database
    ACID compliance
    Data persistence
    Audit trail via login_attempts
    Relationship integrity
end note

@enduml
