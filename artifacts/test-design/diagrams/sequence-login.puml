@startuml Login Sequence Diagram

actor User
participant "HTTP Request" as http
participant "LoggingMiddleware" as logging
participant "AuthRouter" as router
participant "AuthService" as service
participant "Security Utils" as security
participant "Database" as db

User -> http: POST /api/v1/auth/login\n{username/email, password}

http -> logging: Process request
note right of logging
    Generate or extract correlation ID
    Log request metadata (method, path, IP)
    Initialize request context
end note

logging -> router: Route to /login handler

router -> router: Validate schema\n(Pydantic validation)

alt Schema validation fails
    router -> router: Validation error (422)
    router -> logging: Log validation error
    logging -> http: 422 response
    http -> User: Validation error
else Schema validation passes
end

router -> service: authenticate_user(username_or_email, password, ip)

service -> db: Check rate limiting\nFailed attempts < 5 in 15 min?

db -> service: Returns count

alt Rate limit exceeded
    service -> service: Raise RateLimitError
    service -> router: RateLimitError (429)
    router -> logging: Log rate limit error
    logging -> http: 429 response
    http -> User: Too many attempts, try later
else Rate limit not exceeded
end

service -> db: Find user by username OR email
db -> service: Returns user (or null)

alt User not found
    service -> service: Raise AuthenticationError
    service -> db: INSERT failed login attempt
    service -> router: AuthenticationError (401)
    router -> logging: Log auth error
    logging -> http: 401 response
    http -> User: Invalid credentials
else User found
end

alt User is locked
    service -> service: Check lock expiry
    alt Lock still valid
        service -> service: Raise AccountLockedError
        service -> router: AccountLockedError (423)
        router -> logging: Log account locked error
        logging -> http: 423 response
        http -> User: Account locked, try later
    else Lock expired
        service -> db: UPDATE user\nReset is_locked, failed_login_attempts
        note right of db
            Unlock the account
            Reset failure counter
        end note
    end
else User not locked
end

service -> security: verify_password(provided_password, user.password_hash)
note right of security
    Use bcrypt.checkpw()
    Constant-time comparison
    Return boolean
end note
security -> service: is_valid (boolean)

alt Password invalid
    service -> db: Increment failed_login_attempts
    service -> db: INSERT failed login attempt
    alt Now >= 5 attempts
        service -> db: UPDATE user\nSet is_locked = TRUE\nSet locked_until = now + 30min
        note right of db
            Account is now locked
        end note
        service -> service: Raise AuthenticationError
    end
    service -> router: AuthenticationError (401)
    router -> logging: Log auth error
    logging -> http: 401 response
    http -> User: Invalid credentials
else Password valid
end

service -> db: UPDATE user\nSet last_login_at = now
note right of db
    Update last login timestamp
end note

service -> db: INSERT successful login attempt
note right of db
    Record successful login in audit trail
end note

service -> db: Reset failed_login_attempts = 0 (if any)

service -> security: generate_token(user.id)
note right of security
    Create JWT with claims
    user_id, username, email
    Expiry: 30 minutes
    Sign with SECRET_KEY
end note
security -> service: access_token

service -> router: TokenResponse(token, user_data)

router -> logging: Log success response\n(correlation_id, status=200, duration)
logging -> http: 200 OK\n{access_token, user_data, expires_in}

http -> User: Login successful\nToken: {access_token}

@enduml
