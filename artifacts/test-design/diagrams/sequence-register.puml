@startuml Registration Sequence Diagram

actor User
participant "HTTP Request" as http
participant "LoggingMiddleware" as logging
participant "AuthRouter" as router
participant "AuthService" as service
participant "Security Utils" as security
participant "Database" as db

User -> http: POST /api/v1/auth/register\n{username, email, password}

http -> logging: Process request
note right of logging
    Generate correlation ID
    Log request metadata
    Initialize request context
end note

logging -> router: Route to /register handler

router -> router: Validate schema\n(Pydantic validation)

alt Schema validation fails
    router -> router: Validation error (422)
    router -> logging: Log validation error
    logging -> http: 422 response
    http -> User: Validation error
else Schema validation passes
end

router -> service: register_user(username, email, password)

service -> service: validate_username(username)
alt Username invalid
    service -> service: Raise ValidationError
    service -> router: ValidationError
    router -> logging: Log error
    logging -> http: 422 response
    http -> User: Invalid username
else Username valid
end

service -> db: Check username unique
db -> service: Returns count

alt Username already exists
    service -> service: Raise DuplicateUserError
    service -> router: DuplicateUserError
    router -> logging: Log error
    logging -> http: 409 response
    http -> User: Username exists
else Username unique
end

service -> service: validate_email(email)
alt Email invalid format
    service -> service: Raise ValidationError
    service -> router: ValidationError
    router -> logging: Log error
    logging -> http: 422 response
    http -> User: Invalid email
else Email valid format
end

service -> db: Check email unique
db -> service: Returns count

alt Email already exists
    service -> service: Raise DuplicateUserError
    service -> router: DuplicateUserError
    router -> logging: Log error
    logging -> http: 409 response
    http -> User: Email exists
else Email unique
end

service -> service: validate_password(password)
alt Password weak
    service -> service: Raise ValidationError
    service -> router: ValidationError
    router -> logging: Log error
    logging -> http: 422 response
    http -> User: Password too weak
else Password strong
end

service -> security: hash_password(password)
note right of security
    Use bcrypt with cost 12
    ~250ms hashing time
    Random salt per call
end note
security -> service: password_hash

service -> db: INSERT user\n(username, email, password_hash)
db -> db: Execute transaction
db -> service: user (with id)

service -> security: generate_token(user.id)
note right of security
    Create JWT payload
    Add expiry (30 min)
    Sign with SECRET_KEY
end note
security -> service: access_token

service -> router: UserResponse(user_data, token)

router -> logging: Log success response\n(correlation_id, status=201)
logging -> http: 201 Created\n{user_data, token}

http -> User: Registration successful\nToken: {access_token}

@enduml
