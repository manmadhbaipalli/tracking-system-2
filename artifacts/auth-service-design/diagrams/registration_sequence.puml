@startuml Registration Sequence Diagram
!theme cerulean-outline

title User Registration Flow

actor User as user
participant "FastAPI Router" as router
participant "Auth Service" as auth
participant "User Service" as userSvc
participant "Password Utils" as pwd
participant "Database" as db
participant "Circuit Breaker" as cb

user -> router: POST /auth/register\n{email, username, password, confirm_password}

activate router
router -> router: Validate request schema
note right: Pydantic validation:\n- Email format\n- Username length/chars\n- Password complexity\n- Password confirmation

alt Validation successful
    router -> auth: register_user(user_data)
    activate auth

    auth -> auth: Additional business validation
    note right: - Password strength\n- Username restrictions\n- Email domain checks

    alt Business validation passed
        auth -> cb: call(check_user_exists)
        activate cb
        cb -> userSvc: check_email_exists(email)
        activate userSvc

        alt Circuit Breaker Closed
            userSvc -> db: SELECT COUNT(*) FROM users\nWHERE email = ? OR username = ?
            activate db
            db -> userSvc: Count result
            deactivate db
            userSvc -> cb: exists: boolean
            deactivate userSvc
            cb -> auth: exists: boolean
            deactivate cb

            alt User doesn't exist
                auth -> pwd: hash_password(password)
                activate pwd
                pwd -> pwd: Generate salt\nBCrypt hash
                pwd -> auth: hashed_password
                deactivate pwd

                auth -> cb: call(create_user)
                activate cb
                cb -> userSvc: create_user(user_data)
                activate userSvc
                userSvc -> db: INSERT INTO users\n(email, username, hashed_password, ...)
                activate db
                db -> userSvc: New user record
                deactivate db
                userSvc -> cb: User object
                deactivate userSvc
                cb -> auth: User object
                deactivate cb

                auth -> router: UserResponse\n{user_id, email, username, created_at}
                router -> user: 201 Created\n{user_id, email, username, created_at}

            else User already exists
                auth -> router: UserAlreadyExistsException
                router -> user: 409 Conflict\n{error: "User already exists"}
            end

        else Circuit Breaker Open
            cb -> auth: CircuitBreakerException
            deactivate cb
            auth -> router: ServiceUnavailableException
            router -> user: 503 Service Unavailable\n{error: "Service temporarily unavailable"}
        end

    else Business validation failed
        auth -> router: ValidationException
        router -> user: 422 Unprocessable Entity\n{error: "Validation failed", details: [...]}
    end

    deactivate auth

else Schema validation failed
    router -> user: 422 Unprocessable Entity\n{error: "Invalid request format", details: [...]}
end

deactivate router

note over user, db
    **Security & Data Integrity:**
    - Password is hashed before storage (BCrypt)
    - Email and username uniqueness enforced at DB level
    - Input sanitization prevents injection attacks
    - Circuit breaker protects against DB overload
    - No sensitive data in error responses
end note

@enduml