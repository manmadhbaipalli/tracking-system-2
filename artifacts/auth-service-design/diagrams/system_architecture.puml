@startuml System Architecture Diagram
!theme cerulean-outline

title Auth Service System Architecture

!define RECTANGLE class

package "Client Applications" {
    [Web Frontend] as web
    [Mobile App] as mobile
    [API Consumers] as api_clients
}

package "Load Balancer / API Gateway" {
    [Nginx/Traefik] as lb
}

package "Auth Service Container" {

    package "API Layer" {
        [FastAPI Router] as router
        [CORS Middleware] as cors
        [Auth Middleware] as auth_middleware
        [Logging Middleware] as log_middleware
        [Exception Handlers] as handlers
    }

    package "Service Layer" {
        [Auth Service] as auth_service
        [User Service] as user_service
        [Circuit Breaker] as circuit_breaker
    }

    package "Core Infrastructure" {
        [JWT Utils] as jwt
        [Password Utils] as password
        [Config Manager] as config
        [Logger] as logger
    }

    package "Data Access Layer" {
        [SQLAlchemy ORM] as orm
        [Database Session] as session
        [Connection Pool] as pool
    }
}

package "External Dependencies" {
    database "PostgreSQL\n(Primary DB)" as postgres
    database "Redis\n(Optional Cache)" as redis
    [SMTP Server\n(Email)] as smtp
}

package "Monitoring & Observability" {
    [Prometheus\n(Metrics)] as prometheus
    [Grafana\n(Dashboards)] as grafana
    [ELK Stack\n(Logs)] as elk
}

' Client connections
web --> lb : HTTPS
mobile --> lb : HTTPS
api_clients --> lb : HTTPS

' Load balancer to service
lb --> cors : HTTP

' Request flow through middleware
cors --> auth_middleware
auth_middleware --> log_middleware
log_middleware --> handlers
handlers --> router

' Router to services
router --> auth_service : Authentication\nEndpoints
router --> user_service : User Management\nEndpoints

' Service dependencies
auth_service --> jwt : Token\nOperations
auth_service --> password : Password\nHashing
auth_service --> circuit_breaker : Protected\nDB Calls
user_service --> circuit_breaker : Protected\nDB Calls

' Circuit breaker to data layer
circuit_breaker --> orm : Database\nOperations
circuit_breaker --> redis : State Storage\n(Optional)

' Data layer
orm --> session
session --> pool
pool --> postgres

' Infrastructure dependencies
auth_service --> logger : Structured\nLogging
user_service --> logger : Structured\nLogging
circuit_breaker --> logger : State Changes
auth_service --> config : Settings
user_service --> config : Settings

' External integrations
auth_service --> smtp : Email\nVerification
logger --> elk : Log\nAggregation
circuit_breaker --> prometheus : Metrics\nExport
prometheus --> grafana : Data\nVisualization

note right of circuit_breaker
    **Circuit Breaker Protection:**
    - Database connection failures
    - Query timeout handling
    - Connection pool exhaustion
    - Cascade failure prevention
end note

note right of jwt
    **JWT Configuration:**
    - HS256 algorithm
    - 15-minute access tokens
    - Refresh token support
    - Configurable expiration
end note

note right of postgres
    **Database Features:**
    - Connection pooling
    - Read/write separation
    - Backup and recovery
    - Migration management
end note

note left of redis
    **Optional Features:**
    - Session storage
    - Circuit breaker state
    - Rate limiting counters
    - Response caching
end note

@enduml

@startuml Component Dependencies
!theme cerulean-outline

title Component Dependencies and Data Flow

package "External" {
    [HTTP Client] as client
    [Database] as db
    [Cache] as cache
}

package "FastAPI Application" {
    [Main App] as main
    [Routers] as routers
    [Middleware] as middleware
    [Dependencies] as deps
}

package "Services" {
    [Auth Service] as auth_svc
    [User Service] as user_svc
    [Circuit Breaker] as cb
}

package "Models & Schemas" {
    [SQLAlchemy Models] as models
    [Pydantic Schemas] as schemas
}

package "Utilities" {
    [JWT Utils] as jwt_utils
    [Password Utils] as pwd_utils
    [Logger] as logger
    [Config] as config
}

' Dependencies flow
client --> middleware : HTTP Request
middleware --> routers : Processed Request
routers --> deps : Dependency Injection
deps --> auth_svc : Service Call
deps --> user_svc : Service Call

auth_svc --> cb : Protected Operations
user_svc --> cb : Protected Operations
cb --> models : Database Models
models --> db : SQL Queries

auth_svc --> jwt_utils : Token Operations
auth_svc --> pwd_utils : Password Ops
auth_svc --> schemas : Data Validation
user_svc --> schemas : Data Validation

jwt_utils --> config : JWT Settings
pwd_utils --> config : Hash Settings
cb --> config : CB Settings
cb --> cache : State Storage

auth_svc --> logger : Structured Logs
user_svc --> logger : Structured Logs
cb --> logger : State Changes
middleware --> logger : Request Logs

note as N1
    **Dependency Injection Pattern:**
    - Database sessions injected per request
    - Current user context from JWT
    - Configuration loaded at startup
    - Services instantiated with dependencies
end note

note as N2
    **Error Propagation:**
    - Circuit breaker exceptions bubble up
    - Service exceptions handled by routers
    - Custom exceptions with proper HTTP codes
    - Structured error responses
end note

@enduml