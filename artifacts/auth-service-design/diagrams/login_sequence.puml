@startuml Login Sequence Diagram
!theme cerulean-outline

title User Login Authentication Flow

actor User as user
participant "FastAPI Router" as router
participant "Auth Service" as auth
participant "User Service" as userSvc
participant "Database" as db
participant "JWT Utils" as jwt
participant "Circuit Breaker" as cb

user -> router: POST /auth/login\n{email, password}

activate router
router -> router: Validate request schema
note right: Pydantic validation

router -> auth: authenticate_user(credentials)
activate auth

auth -> cb: call(get_user_by_email)
activate cb
cb -> userSvc: get_user_by_email(email)
activate userSvc

alt Circuit Breaker Closed
    userSvc -> db: SELECT * FROM users\nWHERE email = ?
    activate db
    db -> userSvc: User data or None
    deactivate db
    userSvc -> cb: User object
    deactivate userSvc
    cb -> auth: User object
    deactivate cb

    alt User exists
        auth -> auth: verify_password(password, hashed_password)
        note right: BCrypt verification

        alt Password valid
            auth -> jwt: create_access_token(user)
            activate jwt
            jwt -> jwt: Generate JWT payload\n{user_id, exp, iat}
            jwt -> auth: JWT token
            deactivate jwt

            auth -> router: LoginResponse\n{access_token, token_type, expires_in}
            router -> user: 200 OK\n{access_token, token_type, expires_in}

        else Password invalid
            auth -> router: InvalidCredentialsException
            router -> user: 401 Unauthorized\n{error: "Invalid credentials"}
        end

    else User not found
        auth -> router: InvalidCredentialsException
        router -> user: 401 Unauthorized\n{error: "Invalid credentials"}
    end

else Circuit Breaker Open
    cb -> auth: CircuitBreakerException
    deactivate cb
    auth -> router: ServiceUnavailableException
    router -> user: 503 Service Unavailable\n{error: "Service temporarily unavailable"}
end

deactivate auth
deactivate router

note over user, jwt
    **Security Notes:**
    - Passwords are never logged
    - Generic error messages prevent user enumeration
    - JWT tokens have short expiration (15 minutes)
    - Circuit breaker protects against database failures
end note

@enduml