You are an autonomous coding agent. Your job is to complete the task below.

## Task: auth-service-review
**[REVIEW] auth-service**

**Pipeline:** `auth-service` | **Phase:** `review`

## Description
1. Analyze the below requirement
	1. Create fastapi application with login, registration endpoints
	2. centralized logging system
	3. centralized exception handling
	4. implement circuit breaker
	5. swagger for all endpoints
2. Design the application
	1. Sequence Diagrams and flow diagrams in platuml
	2. design and create the db schema/tables
3. code implementation with proper testcases
4. execute testcases
5. review and optimize if any issues.

## Phase: review
Review all code changes for quality, security, and correctness. Read all prior artifacts. Write review findings to artifacts/{task_id}/review.md.

**Note:** This task depended on: auth-service-test. Those are now merged into main.

## File Constraints
You may ONLY modify these files (other files are locked by other agents working in parallel):
  (no file restrictions — you may modify any file)

If you need to create new files, place them under the directories implied by the locked file paths.
Do NOT modify files outside your assigned scope — doing so will cause merge conflicts.

## Phase Role: Code Review
You are the **review agent**. Your job is to review all changes for completeness, quality, security, and correctness.

### Prior Work
Read all prior phase artifacts:
- Feature list: `artifacts/auth-service-test/features.json` — the latest feature status with test coverage
- Analysis: `artifacts/auth-service-analysis/analysis.md`
- Design: `artifacts/auth-service-design/design.md`
- Implementation: `artifacts/auth-service-implement/implementation.md`
- Test results: `artifacts/auth-service-test/test-results.md`
- Coding standards: `CLAUDE.md` in the project root

### What to do
1. Read features.json first — this is your completeness checklist
2. Read all other artifacts to understand the full context
3. **Completeness check**: Verify every feature in features.json has status `"done"` and `"tested": true`. List any that are missing, partial, or untested
4. **Stub check**: Look for any source files that are empty or contain only docstrings/`pass`
5. Review every code change for correctness and clarity
6. Check for security vulnerabilities (OWASP top 10: injection, XSS, auth issues, etc.)
7. Verify error handling and edge cases
8. Ensure code follows conventions from CLAUDE.md
9. Run the full test suite and capture the output
10. Fix any issues you find — you are authorized to make changes

### Review Checklist
You MUST evaluate each item:
- [ ] Every feature in features.json is implemented (not stubs)
- [ ] Every feature in features.json is tested
- [ ] All tests are passing
- [ ] No empty or stub-only files committed
- [ ] Security review completed (no hardcoded secrets, no injection vulnerabilities)
- [ ] Error handling is adequate
- [ ] Code follows CLAUDE.md conventions

### Output
**1. Write `artifacts/auth-service-review/features.json`** — final feature status with `"reviewed": true` field added

**2. Write `artifacts/auth-service-review/review.md`** with these sections:
- **Feature Completeness**: For each feature in features.json, state: implemented/missing/stubbed and tested/untested
- **Test Suite Output**: Full pytest output from your test run
- **Issues Found**: Problems discovered, each with severity (CRITICAL / MAJOR / MINOR)
- **Fixes Applied**: Changes you made during review
- **Final Verdict**: APPROVE (ready to merge), or BLOCK (with specific reasons)


## Quality Requirements
- Write tests for any new functionality
- Do not break existing tests
- Follow the project's coding standards (see below)
- Implement all components fully — do not leave stub files

## Project Standards
# Auth Service Project Standards

## Tech Stack

- **Language**: Python 3.11+
- **Framework**: FastAPI (modern async web framework)
- **Database**: PostgreSQL (relational database for user data)
- **ORM**: SQLAlchemy (database abstraction layer)
- **Testing**: pytest (test framework with fixtures)
- **Package Manager**: pip / poetry
- **Async Support**: asyncio, httpx (for async HTTP calls)
- **Security**: PyJWT (JWT tokens), passlib + bcrypt (password hashing), python-multipart (form data)
- **API Documentation**: Swagger/OpenAPI (built into FastAPI)
- **Logging**: Python logging module (standard library)
- **Validation**: Pydantic (data validation and serialization)
- **Environment Configuration**: python-dotenv (environment variables)

## Project Structure

The project will follow this structure:

```
auth-service-agent-1/
â”œâ”€â”€ CLAUDE.md                          # This file - project standards
â”œâ”€â”€ README.md                          # Project documentation
â”œâ”€â”€ requirements.txt                   # Python dependencies
â”œâ”€â”€ .env.example                       # Example environment variables
â”œâ”€â”€ .gitignore                         # Git ignore rules
â”œâ”€â”€ app/                               # Main application package
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                        # FastAPI app initialization
â”‚   â”œâ”€â”€ config.py                      # Configuration and settings
â”‚   â”œâ”€â”€ models/                        # SQLAlchemy ORM models
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ user.py                    # User model
â”‚   â”œâ”€â”€ schemas/                       # Pydantic schemas for request/response
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ user.py                    # User schemas (LoginRequest, RegisterRequest, etc.)
â”‚   â”œâ”€â”€ database/                      # Database setup and session management
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ connection.py              # Database connection and session factory
â”‚   â”œâ”€â”€ handlers/                      # Exception and error handlers
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ exceptions.py              # Custom exceptions and handlers
â”‚   â”œâ”€â”€ services/                      # Business logic layer
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ auth_service.py            # Authentication logic
â”‚   â”‚   â””â”€â”€ circuit_breaker.py         # Circuit breaker pattern
â”‚   â”œâ”€â”€ routers/                       # API route handlers
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ auth.py                    # /login, /register endpoints
â”‚   â”œâ”€â”€ middleware/                    # Custom middleware
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ logging.py                 # Logging middleware
â”‚   â””â”€â”€ utils/                         # Utility functions
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ security.py                # JWT, password hashing utilities
â”œâ”€â”€ migrations/                        # Alembic database migrations
â”‚   â”œâ”€â”€ versions/
â”‚   â”œâ”€â”€ env.py
â”‚   â”œâ”€â”€ script.py.mako
â”‚   â””â”€â”€ alembic.ini
â”œâ”€â”€ tests/                             # Test suite
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ conftest.py                    # Pytest fixtures and configuration
â”‚   â”œâ”€â”€ test_auth.py                   # Auth endpoint tests
â”‚   â”œâ”€â”€ test_models.py                 # Model tests
â”‚   â”œâ”€â”€ test_services.py               # Service layer tests
â”‚   â””â”€â”€ test_circuit_breaker.py        # Circuit breaker tests
â”œâ”€â”€ artifacts/                         # Analysis and design documents
â”‚   â””â”€â”€ auth-service-analysis/
â”‚       â”œâ”€â”€ analysis.md                # Detailed analysis document
â”‚       â”œâ”€â”€ database-schema.sql        # SQL schema
â”‚       â””â”€â”€ diagrams/                  # PlantUML diagrams
â”‚           â”œâ”€â”€ sequence-diagram.puml
â”‚           â””â”€â”€ flow-diagram.puml
â”œâ”€â”€ docker/                            # Docker configuration (optional)
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ docker-compose.yml
â””â”€â”€ scripts/                           # Utility scripts
    â””â”€â”€ setup_db.py                    # Database initialization script
```

## Coding Conventions

### Python Style
- **PEP 8 Compliance**: Follow PEP 8 with line length of 100 characters
- **Formatting**: Use Black for code formatting
- **Linting**: Use Flake8 or Ruff for linting
- **Type Hints**: Always use type hints for function signatures and class variables
- **Imports**: Organize imports in three groups: stdlib, third-party, local (sorted alphabetically within groups)
  ```python
  # stdlib
  import os
  from typing import Optional

  # third-party
  from fastapi import FastAPI, HTTPException
  from sqlalchemy import Column, String

  # local
  from app.config import settings
  from app.models.user import User
  ```

### Naming Conventions
- **Classes**: PascalCase (e.g., `UserService`, `AuthException`)
- **Functions/Methods**: snake_case (e.g., `validate_password`, `create_user`)
- **Constants**: UPPER_SNAKE_CASE (e.g., `MAX_LOGIN_ATTEMPTS`, `TOKEN_EXPIRY`)
- **Private Methods**: Leading underscore (e.g., `_hash_password`)
- **Database Tables**: snake_case (e.g., `users`, `refresh_tokens`)

### Code Organization
- **One responsibility per class/module**: Follow Single Responsibility Principle
- **Async functions**: Use `async def` for I/O operations, prefix async context managers with `async with`
- **Exception handling**: Catch specific exceptions, not `Exception`
- **Logging**: Use module-level logger: `logger = logging.getLogger(__name__)`
- **Docstrings**: Use Google-style docstrings for public functions/classes:
  ```python
  def authenticate_user(username: str, password: str) -> Optional[User]:
      """Authenticate a user by username and password.

      Args:
          username: The user's username.
          password: The user's plaintext password.

      Returns:
          The authenticated User object or None if authentication fails.

      Raises:
          AuthenticationError: If authentication fails.
      """
  ```

### FastAPI Patterns
- **Dependency Injection**: Use FastAPI's `Depends()` for injecting dependencies
- **Request/Response Models**: Define Pydantic models for all endpoints
- **Status Codes**: Use appropriate HTTP status codes (200, 201, 400, 401, 403, 404, 500)
- **Error Responses**: Use `HTTPException` with consistent error format:
  ```python
  from fastapi import HTTPException
  raise HTTPException(status_code=401, detail="Invalid credentials")
  ```

### Database Patterns
- **SQLAlchemy Models**: Define ORM models in `models/` directory
- **Session Management**: Use context managers for database sessions
- **Migrations**: Use Alembic for schema migrations
- **Transactions**: Wrap operations in database transactions

### Testing Patterns
- **Test Organization**: Group tests by module (test_auth.py, test_services.py)
- **Fixtures**: Use pytest fixtures in `conftest.py` for setup/teardown
- **Mocking**: Use `unittest.mock` or `pytest-mock` for external dependencies
- **Test Names**: Use descriptive names: `test_register_user_success`, `test_login_invalid_password`
- **Coverage**: Aim for >80% code coverage

## Commands

### Setup & Installation
```bash
# Create virtual environment
python -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate

# Install dependencies
pip install -r requirements.txt

# Setup database
python scripts/setup_db.py
```

### Running the Application
```bash
# Development server with auto-reload
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# Production server
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

### Testing
```bash
# Run all tests
pytest

# Run with coverage
pytest --cov=app --cov-report=html

# Run specific test file
pytest tests/test_auth.py

# Run with verbose output
pytest -v

# Run tests matching pattern
pytest -k "test_login"
```

### Database
```bash
# Create migrations
alembic revision --autogenerate -m "Add users table"

# Apply migrations
alembic upgrade head

# Rollback migration
alembic downgrade -1
```

### Code Quality
```bash
# Format code
black app/ tests/

# Lint code
flake8 app/ tests/

# Type checking
mypy app/

# All checks together
black --check app/ tests/ && flake8 app/ tests/ && mypy app/
```

### API Documentation
- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc
- **OpenAPI Schema**: http://localhost:8000/openapi.json

## Key Patterns

### 1. Service Layer Pattern
Business logic is separated from route handlers into service classes:
```python
# In app/services/auth_service.py
class AuthService:
    async def register_user(self, username: str, email: str, password: str) -> User:
        # Implementation

    async def authenticate_user(self, username: str, password: str) -> User:
        # Implementation
```

### 2. Dependency Injection
FastAPI's dependency system is used for injecting services and database sessions:
```python
async def get_db() -> AsyncGenerator[AsyncSession, None]:
    async with async_session_maker() as session:
        yield session

# In route handler
@router.post("/login")
async def login(request: LoginRequest, db: AsyncSession = Depends(get_db)):
    service = AuthService(db)
    return await service.authenticate_user(...)
```

### 3. Circuit Breaker Pattern
For external service calls, implement circuit breaker to handle failures:
```python
class CircuitBreaker:
    async def call(self, func, *args, **kwargs):
        # Check state and call function with fallback
```

### 4. Custom Exception Handling
Centralized exception handlers for consistent error responses:
```python
@app.exception_handler(AuthenticationError)
async def auth_error_handler(request, exc):
    return JSONResponse(
        status_code=401,
        content={"detail": str(exc)}
    )
```

### 5. Structured Logging
All modules use structured logging with correlation IDs for tracing:
```python
import logging
logger = logging.getLogger(__name__)

logger.info("User registration", extra={"user_id": user.id, "request_id": request_id})
```

## Development Workflow

1. **Create a new branch** for features: `git checkout -b feature/feature-name`
2. **Write tests first** (TDD approach when possible)
3. **Implement feature** following coding conventions
4. **Run tests and linters** before committing
5. **Commit with clear messages**: `git commit -m "feat: add user registration endpoint"`
6. **Create pull request** for code review

## Environment Variables

Create a `.env` file based on `.env.example`:
```
# Database
DATABASE_URL=postgresql+asyncpg://user:password@localhost/auth_db

# JWT
SECRET_KEY=your-secret-key-here
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30

# Logging
LOG_LEVEL=INFO
LOG_FORMAT=json

# Circuit Breaker
CIRCUIT_BREAKER_FAILURE_THRESHOLD=5
CIRCUIT_BREAKER_RECOVERY_TIMEOUT=60

# Security
MAX_LOGIN_ATTEMPTS=5
LOGIN_ATTEMPT_TIMEOUT=900
```

## Notes for Agents

- This is a greenfield FastAPI project for building an authentication service
- All new code should be async-first (using `async`/`await`)
- Use SQLAlchemy ORM with async support (`asyncpg` driver for PostgreSQL)
- Implement comprehensive tests for all business logic
- Use Pydantic for request/response validation
- Centralize all error handling and logging
- Document all endpoints with OpenAPI decorators for Swagger

